# Backend Tasks
Система учёта автопарка предприятий (SaaS)

Файл описывает **только backend‑задачи** (Django + DRF), ориентированные на использование из будущего React‑frontend. Все задачи предполагают REST API (JSON), без HTML‑шаблонов (кроме стандартной админки и Swagger).

Нумерация задач: `BE-XXX` – основная задача, `BE-XXX.X` – подзадача.

---

## 0. Общие принципы и архитектура

### BE-000. Общие технические решения backend

- [ ] **BE-000.1** Определить целевой стек:
  - Python 3.11+
  - Django 4.2+
  - DRF 3.16+
  - PostgreSQL (prod), SQLite (dev – по необходимости)
  - JWT (SimpleJWT или аналог)
- [ ] **BE-000.2** Принять структуру проекта по приложениям:
  - `core` – общие утилиты, mixin’ы, базовые классы.
  - `accounts` – пользователи, авторизация, роли.
  - `companies` – компании (арендаторы).
  - `fleet` – машины и связанные сущности (ТО, топливо, страховки и т.д.).
  - `reports` – отчёты и экспорт.
- [ ] **BE-000.3** Определить соглашения по именованию, стилю кода и организации API:
  - Префикс API: `/api/v1/`.
  - Стандартный формат ответов и ошибок.
  - Пагинация и фильтрация.

---

## 1. Базовая инфраструктура и конфигурация

### BE-010. Конфигурация окружений и секретов

- [ ] **BE-010.1** Расширить настройки Django:
  - Ввести структуру `config/settings/base.py`, `dev.py`, `prod.py`.
  - Вынести секретные и средо-зависимые параметры (SECRET_KEY, БД и т.п.).
- [ ] **BE-010.2** Подключить чтение `.env`:
  - Использовать `django-environ` или аналог.
  - Настроить переменные для БД, DEBUG, ALLOWED_HOSTS.

### BE-011. База данных и Docker (минимум)

- [ ] **BE-011.1** Подготовить конфигурацию PostgreSQL:
  - Параметры подключения в `settings/prod.py`.
- [ ] **BE-011.2** Создать минимальный `docker-compose.yml` (опционально, под дальнейшую работу):
  - Сервисы: `web` (backend), `db` (PostgreSQL).

---

## 2. Multi-tenant: компании и пользователи

### BE-020. Модель Company и базовая логика

- [ ] **BE-020.1** Создать модель `Company`:
  - Основные поля: `name`, `slug`, `country`, `timezone`, `default_language`, `default_currency` (KGS по умолчанию), реквизиты (по необходимости).
  - FK на `created_by` (админ, создавший компанию – на будущее).
- [ ] **BE-020.2** Добавить индексы и ограничения:
  - Уникальность `slug`.
  - Индексация по `name`.
- [ ] **BE-020.3** Реализовать сериализатор и админку для `Company` (для внутреннего использования).

### BE-021. Кастомная модель User и роли

- [ ] **BE-021.1** Создать кастомную модель `User` (на базе `AbstractUser`):
  - Дополнительные поля: `region`, `role`, `language`, FK `company`.
  - Роль как Choice/Enum: `COMPANY_ADMIN`, `DISPATCHER`, `MECHANIC`, `DRIVER`, `ACCOUNTANT`, `GUEST`.
- [ ] **BE-021.2** Настроить `AUTH_USER_MODEL` и миграции.
- [ ] **BE-021.3** Реализовать менеджер пользователя (если нужно) для выборок по компании.
- [ ] **BE-021.4** Настроить сериализатор `UserSerializer`:
  - Отдельный сериализатор для списка/деталей и для создания/обновления.
- [ ] **BE-021.5** Добавить модель/enum для регионов, языков (RU/EN/KY) и, по возможности, вынести справочные значения в отдельные классы/choices.

### BE-022. Авторизация и JWT

- [ ] **BE-022.1** Подключить JWT-аутентификацию (SimpleJWT или аналог).
- [ ] **BE-022.2** Настроить эндпоинты:
  - `POST /api/v1/auth/login/` – приём логина/пароля, выдача access/refresh.
  - `POST /api/v1/auth/refresh/` – обновление токена.
  - `POST /api/v1/auth/logout/` – инвалидация refresh (по возможности).
- [ ] **BE-022.3** Реализовать сериализаторы/валидаторы логина.
- [ ] **BE-022.4** Настроить глобальную аутентификацию и permissions в DRF settings.

### BE-023. Права доступа и контекст компании

- [ ] **BE-023.1** Реализовать permission‑классы:
  - `IsCompanyAdmin` – полный доступ к сущностям компании.
  - `IsCompanyStaff` (диспетчер/механик/бухгалтер и т.п.) – права на модификацию в рамках ролей.
  - `IsCompanyGuestReadOnly` – только чтение.
- [ ] **BE-023.2** Реализовать mixin/базовый viewset для фильтрации по компании:
  - Автоматическое применение `queryset.filter(company=request.user.company)`.
- [ ] **BE-023.3** Настроить глобальные фильтры/permissions для всех viewset’ов в приложениях `fleet` и `reports`.

### BE-024. Управление пользователями компании (Company Admin)

- [ ] **BE-024.1** Реализовать `UserViewSet` с базовым CRUD:
  - Список и создание пользователей текущей компании (доступно только Company Admin).
  - Детальный просмотр/редактирование/деактивация пользователя.
- [ ] **BE-024.2** Ограничить создание/редактирование пользователей в рамках одной компании.
- [ ] **BE-024.3** Добавить эндпоинт текущего пользователя:
  - `GET /api/v1/auth/me/` – профиль.
  - `PATCH /api/v1/auth/me/` – обновление некоторых полей (например, язык).

---

## 3. Справочники и общие сущности

### BE-030. Справочники (бренды, типы ТС, виды топлива и т.п.)

- [ ] **BE-030.1** Определить, какие справочники нужны на backend:
  - Регионы.
  - Типы топлива (бензин, дизель, газ и т.п.).
  - Типы ТС (легковой, грузовой, специальный и т.п.).
  - Марки авто (из `filesforai.txt`).
- [ ] **BE-030.2** Реализовать способ хранения:
  - Либо как Choices/Enum в коде.
  - Либо как отдельные таблицы (если требуется изменение через админку).
- [ ] **BE-030.3** Реализовать endpoints для чтения справочников (если необходимо для фронта):
  - `GET /api/v1/dictionaries/...` (только чтение).

---

## 4. Fleet: машины и связанные сущности

Все модели в этом блоке должны иметь FK `company` (либо через `Car` → `company`) и учитываться в фильтрации по компании.

### BE-040. Модель Car и базовые операции

- [ ] **BE-040.1** Спроектировать модель `Car` (на основе `filesforai.txt` и TZ):
  - Поля: `company`, `region`, `brand`, `title`, `numplate`, `year`, `vin`, `fueltype`, `type`, `driver`, `drivers_phone`, `fuel_card`, статус машины, дата ввода в эксплуатацию.
  - Уникальность: `numplate`, `vin` внутри компании.
- [ ] **BE-040.2** Добавить методы бизнес‑логики:
  - Авто‑приведение номера к верхнему регистру.
  - Приведение формата ФИО водителя (как в примере).
- [ ] **BE-040.3** Реализовать сериализаторы:
  - Список (краткая версия).
  - Детальный (со связями/агрегатами при необходимости).
- [ ] **BE-040.4** Реализовать `CarViewSet`:
  - CRUD‑операции.
  - Фильтрация по региону, типу, бренду, номеру, статусу.
  - Пагинация.
- [ ] **BE-040.5** Настроить permissions:
  - Создание/редактирование – админ/диспетчер.
  - Просмотр – все роли компании, включая Guest.

### BE-041. CarPhoto – фотографии машин

- [ ] **BE-041.1** Спроектировать модель `CarPhoto`:
  - FK на `Car`, поле `image` (ImageField) + метаданные (комментарий, дата загрузки).
- [ ] **BE-041.2** Настроить хранение файлов (MEDIA_ROOT, MEDIA_URL), без HTML-страниц.
- [ ] **BE-041.3** Реализовать сериализатор и `ViewSet`:
  - `GET /api/v1/cars/{id}/photos/` – список.
  - `POST /api/v1/cars/{id}/photos/` – загрузка фото.
  - `DELETE /api/v1/cars/photos/{photo_id}/`.

### BE-042. Spare (SparePart) – запчасти и работы

- [ ] **BE-042.1** Спроектировать модель `Spare`:
  - FK на `Car` и `company` (через Car).
  - Поля: наименование, описание, цена запчасти, описание работы, цена работы, дата установки.
- [ ] **BE-042.2** Реализовать сериализаторы (создание/редактирование, список).
- [ ] **BE-042.3** Реализовать `SpareViewSet`:
  - CRUD для запчастей машины.
  - Фильтрация по машине, дате, типу/категории запчасти (если есть).

### BE-043. Tires – учёт шин

- [ ] **BE-043.1** Спроектировать модель `Tires`:
  - FK на `Car`.
  - Поля: модель, размер, цена, фото (опционально), дата установки, дата окончания эксплуатации.
- [ ] **BE-043.2** Реализовать сериализаторы и `ViewSet`:
  - CRUD.
  - Фильтрация по машине и периоду.

### BE-044. Accumulator – учёт аккумуляторов

- [ ] **BE-044.1** Спроектировать модель `Accumulator`:
  - FK на `Car`.
  - Поля: модель, серийный номер, ёмкость, цена, дата установки, дата эксплуатации до, фото (опционально).
- [ ] **BE-044.2** Реализовать сериализаторы и `ViewSet`.

### BE-045. Fuel – учёт топлива

- [ ] **BE-045.1** Спроектировать модель `Fuel`:
  - FK на `Car`.
  - Поля: месяц, год, количество (литры), общая стоимость, пробег за месяц, расход топлива (автовычисляемое поле), строковое имя месяца.
- [ ] **BE-045.2** Реализовать бизнес‑логику в `save()`/сервисе:
  - Расчёт расхода (`литры / пробег * 100`).
  - Присвоение имени месяца (RU/KY/EN – по локали или коду).
- [ ] **BE-045.3** Реализовать сериализаторы и `ViewSet`:
  - CRUD.
  - Фильтрация по машине, месяцу, году.

### BE-046. Insurance – страховки (КАСКО/ОСАГО)

- [ ] **BE-046.1** Спроектировать модель `Insurance`:
  - FK на `Car`.
  - Поля: тип страховки, номер, дата начала, дата окончания, стоимость.
- [ ] **BE-046.2** Реализовать сериализаторы и `ViewSet`:
  - CRUD.
  - Фильтрация по статусу (активная/просроченная), машине, периоду.

### BE-047. Inspection – техосмотры

- [ ] **BE-047.1** Спроектировать модель `Inspection`:
  - FK на `Car`.
  - Поля: номер, дата проведения, стоимость.
- [ ] **BE-047.2** Реализовать сериализаторы и `ViewSet`:
  - CRUD.
  - Фильтрация по машине и периоду.

### BE-048. Recorder – видеорегистратор

- [ ] **BE-048.1** Спроектировать модель `Recorder` (OneToOne к `Car`):
  - Поля: модель, серийный номер, дата установки, опциональное фото.
- [ ] **BE-048.2** Реализовать сериализатор и `ViewSet`:
  - CRUD.
  - Гарантировать, что у машины не более одного регистратора.

### BE-049. Kit – комплектность

- [ ] **BE-049.1** Спроектировать модель `Kit` (OneToOne к `Car`):
  - Поля: флаги наличия (домкрат, баллонный ключ, знак, огнетушитель, аптечка и т.д.), даты годности, логика обнуления дат, если предмета нет.
- [ ] **BE-049.2** Реализовать сериализатор и `ViewSet`:
  - CRUD.

### BE-050. MonthlyMileage – ежемесячный пробег

- [ ] **BE-050.1** Спроектировать модель `MonthlyMileage`:
  - FK на `Car`.
  - Поля: месяц (`YYYY-MM`), пробег, уникальная пара (`car`, `month`).
- [ ] **BE-050.2** Реализовать сериализатор и `ViewSet`:
  - CRUD.
  - Валидация формата месяца.

### BE-051. Расширения на будущее (без реализации логики сейчас)

- [ ] **BE-051.1** Спроектировать (на уровне черновика моделей) `Accident` (ДТП) и `TransferAct` (акт приёма‑передачи), без реализации endpoint’ов.

---

## 5. Reports: отчёты и экспорт

### BE-060. Общий сервис отчётности

- [ ] **BE-060.1** Спроектировать слой сервисов для отчётов (отдельные классы/функции, без привязки к DRF):
  - Отчёт по топливу и пробегу.
  - Отчёт по затратам на запчасти и ремонты.
  - Отчёт по страховкам и техосмотрам.
- [ ] **BE-060.2** Определить DTO/структуры данных, которые будут возвращаться сервисами (агрегаты, группировки).

### BE-061. Отчёт по топливу и пробегу

- [ ] **BE-061.1** Реализовать сервис:
  - Вход: компания, набор машин (или одна машина), период (месяц/год/диапазон).
  - Выход: суммарный пробег, расход, объём топлива, средний расход.
- [ ] **BE-061.2** Реализовать endpoint:
  - `GET /api/v1/reports/fuel-consumption/`.
  - Параметры: `company` (из пользователя), `car`, `from`, `to`, `group_by` (месяц/год).
  - Поддержка параметра `export={json|csv|xlsx}`.

### BE-062. Отчёт по затратам на ТО и ремонты

- [ ] **BE-062.1** Реализовать сервис отчёта по затратам:
  - Вход: компания, период.
  - Источники: `Spare` (запчасти + работы), возможно `Inspection`.
- [ ] **BE-062.2** Реализовать endpoint:
  - `GET /api/v1/reports/maintenance-costs/` с параметрами фильтрации и `export={json|csv|xlsx}`.

### BE-063. Отчёт по страховкам и техосмотрам

- [ ] **BE-063.1** Реализовать сервис, который:
  - Показывает актуальные, скоро истекающие и просроченные страховки и техосмотры.
- [ ] **BE-063.2** Реализовать endpoint:
  - `GET /api/v1/reports/insurance-inspection/` с фильтрами по статусу, периоду, машине и параметром `export`.

### BE-064. Экспорт в CSV/XLSX

- [ ] **BE-064.1** Реализовать единый утилитный модуль для экспорта:
  - Генерация CSV.
  - Генерация XLSX (например, через `openpyxl` или `xlsxwriter`).
- [ ] **BE-064.2** Интегрировать утилиту экспорта с endpoint’ами отчётов (`export=`).

---

## 6. Документация, админка и сервисные вещи

### BE-070. Django Admin

- [ ] **BE-070.1** Зарегистрировать основные модели в админке:
  - `Company`, `User`, `Car` и ключевые связанные сущности.
- [ ] **BE-070.2** Настроить список, фильтры и поиск в админке для удобства отладки и поддержки.

### BE-071. Документация API (Swagger/OpenAPI)

- [ ] **BE-071.1** Подключить генерацию OpenAPI/Swagger (drf-spectacular или drf-yasg).
- [ ] **BE-071.2** Настроить доступ к документации:
  - Только для авторизованных (по настройке).
  - Путь, например, `/api/schema/`, `/api/docs/`.

### BE-072. Глобальные настройки DRF

- [ ] **BE-072.1** Настроить:
  - Пагинацию по умолчанию (page size, max page size).
  - Глобальные `DEFAULT_PERMISSION_CLASSES` и `DEFAULT_AUTHENTICATION_CLASSES`.
  - Формат ошибок и рендереры (JSON only).

---

## 7. Связь с frontend (React)

### BE-080. Контракты API для фронта

- [ ] **BE-080.1** Для ключевых сущностей (Auth, User, Car, Fuel, Reports) зафиксировать формат запросов/ответов (DTO) в виде OpenAPI‑схемы.
- [ ] **BE-080.2** Согласовать наименования полей и структуры с фронтом, чтобы упростить интеграцию.

## 8. AI‑ассистент (после MVP)

### BE-090. Архитектура и границы AI‑слоя

- [ ] **BE-090.1** Определить способ интеграции AI:
  - Внешний AI‑сервис (SaaS/API) или собственный сервис внутри инфраструктуры.
  - Формат обмена: REST/JSON.
- [ ] **BE-090.2** Определить объём данных, доступных AI:
  - Только данные текущей компании (полная изоляция между компаниями).
  - Ограничение по типам сущностей (Car, Fuel, Spare, Reports и т.д.).
- [ ] **BE-090.3** Определить список поддерживаемых сценариев:
  - Генерация текстовых отчётов/резюме.
  - Подготовка агрегированных данных для графиков.
  - Формирование предложений по созданию/изменению/удалению записей.

### BE-091. Подготовка данных и доступ для AI

- [ ] **BE-091.1** Реализовать сервис/фасад доступа к данным для AI:
  - Чтение агрегированных данных по автопарку (машины, топливо, ТО, страховки, пробег).
  - Учёт фильтрации по компании и ролям пользователя.
- [ ] **BE-091.2** Ограничить максимальные объёмы данных, передаваемых за один запрос (пагинация/агрегация).
- [ ] **BE-091.3** Обеспечить анонимизацию/минимизацию чувствительных данных там, где это возможно.

### BE-092. Endpoint для диалога с AI

- [ ] **BE-092.1** Реализовать endpoint чата с AI:
  - `POST /api/v1/ai/chat/`.
  - Вход: текст запроса пользователя, язык, опциональный контекст (ID машины, период и т.п.).
  - Выход: текстовый ответ AI + структурированная информация о предложенных действиях (если есть).
- [ ] **BE-092.2** Интегрировать endpoint с выбранным AI‑сервисом:
  - Формирование промпта на основе данных компании и роли пользователя.
  - Обработка ответа и маппинг в структуру, понятную фронтенду.

### BE-093. Выполнение действий по запросу AI

- [ ] **BE-093.1** Реализовать служебный endpoint для выполнения действий, предложенных AI:
  - `POST /api/v1/ai/actions/`.
  - Вход: перечень действий (create/update/delete) с указанием сущностей и полей.
  - Выход: результат выполнения по каждому действию (успех/ошибка, детали).
- [ ] **BE-093.2** Использовать существующие сервисы/endpoint’ы domain‑логики (`Car`, `Fuel`, `Spare` и т.д.), не давая AI прямого доступа к БД.
- [ ] **BE-093.3** Реализовать механизм «dry‑run»:
  - Возможность получить от backend список предполагаемых изменений без фактической записи в БД.

### BE-094. Безопасность и аудит AI‑действий

- [ ] **BE-094.1** Убедиться, что все действия, инициированные через AI, проходят через обычные механизмы аутентификации и авторизации DRF.
- [ ] **BE-094.2** Реализовать аудит‑лог для AI‑операций:
  - Сохранять запрос пользователя (в разумных пределах), ответ AI и фактически выполненные изменения.
  - Привязка к пользователю, компании и времени выполнения.
- [ ] **BE-094.3** Предусмотреть возможность отключения AI‑функций на уровне компании (флаг в настройках компании).

