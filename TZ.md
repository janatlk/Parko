# Техническое задание
## Система учёта автопарка предприятий (SaaS)

---

## 1. Назначение и общая концепция

Система представляет собой многоарендный (multi-tenant) web‑сервис для учёта автопарка компаний.

- Каждая компания имеет полностью изолированные данные (машины, пользователи, отчёты).
- Доступ осуществляется через web‑интерфейс (desktop и mobile‑версия), авторизация по логину и паролю.
- Языки интерфейса: **RU / EN / KY** (поддержка i18n с возможностью добавлять новые языки).
- Базовая валюта: **KGS (сом)**, с возможностью в будущем переключать валюту на уровне компании.

MVP не включает интеграции с GPS/телематикой, 1С и топливными картами и не предполагает автозагрузку данных — ввод данных вручную через UI.

---

## 2. Роли и права доступа

Реализовать ролевую модель с привязкой пользователей к компаниям.

### 2.1. Основные роли (на уровне компании)

- **Company Admin (Админ компании)**
  - Создаёт и редактирует пользователей своей компании, назначает роли.
  - Полный доступ ко всем сущностям компании (авто, ТО, топливо, отчёты и т.д.).
  - Настройка параметров компании (язык по умолчанию, валюта, реквизиты и т.п.).

- **Dispatcher (Диспетчер)**
  - Управление автопарком: создание/редактирование машин, водителей (если будет отдельная сущность), базовых карточек по эксплуатации.
  - Ввод и корректировка записей по пробегу, топливу, ТО/ремонтам, страховке, техосмотрам.
  - Просмотр отчётов по своей компании.

- **Mechanic (Механик)**
  - Ввод данных по ТО/ремонтам, запчастям, работам.
  - Просмотр карточек машин, истории ремонтов, шин, аккумуляторов.

- **Driver (Водитель)**
  - Ограниченный доступ только к «своим» машинам.
  - Возможность просматривать базовую информацию по машине и передавать показания (пробег, топливо) — в дальнейших версиях.

- **Accountant (Бухгалтер)**
  - Просмотр финансовых показателей: расходы на топливо, запчасти, страховки, техосмотры.
  - Формирование и экспорт отчётов.

- **Guest (Гость / Viewer)**
  - Только просмотр основных списков и отчётов, **без** права создавать/редактировать/удалять.

### 2.2. Права доступа (общее правило)

- **Админ компании** – полный доступ внутри компании ко всем данным.
- **Обычные пользователи (диспетчер, механик, водитель, бухгалтер)** – доступ ограничен ролью (см. выше).
- **Гость** – только чтение и экспорт отчётов.
- В дальнейшем предусмотреть возможность тонкой настройки прав (RBAC) на уровне действий (create/read/update/delete).

---

## 3. Функциональные требования (MVP)

### 3.1. Основные сущности (на основе файла `filesforai.txt`)

Обязательные сущности (связаны с компанией через FK `company`):

- **Company** – компания‑клиент.
- **User** – кастомная модель пользователя (на основе `AbstractUser`):
  - Поля: `username`, `email`, `password`, `first_name`, `last_name`, `region`, `role`, `language`, `company`, `is_active` и т.п.
- **Car** – автомобиль:
  - Базироваться на структуре из `filesforai.txt`: `region`, `brand`, `title`, `numplate`, `year`, `vin`, `fueltype`, `type`, `driver`, `drivers_phone`, `fuel_card` и т.д.
  - Дополнительно: статус (активен/списан/в ремонте), дата ввода в эксплуатацию.
- **CarPhoto** – фото автомобиля (ManyToOne к `Car`).
- **Spare (SparePart)** – запчасти:
  - Наименование, описание, цена запчасти, описание работы, стоимость работы, дата установки.
  - Привязка к `Car`.
- **Tires** – учёт шин.
- **Accumulator** – учёт аккумуляторов.
- **Fuel** – учёт топлива:
  - Месяц, год, объём (литры), общая стоимость, пробег за месяц, расчёт расхода (`литры/100км`).
- **Insurance** – страховки (КАСКО/ОСАГО):
  - Номер, тип, дата начала, дата окончания, стоимость.
- **Inspection** – техосмотры:
  - Номер, дата, стоимость.
- **Recorder** – видеорегистраторы (OneToOne к `Car`).
- **Kit** – комплектность (домкрат, баллонный ключ, аптечка и т.п.), даты годности.
- **MonthlyMileage** – ежемесячный пробег (уникальная пара `car` + `month`).

Планируемые сущности для следующих версий (заложить в модель архитектурно, реализацию можно отложить):

- **Accident (ДТП)** – история ДТП по машине.
- **TransferAct (Акт приёма‑передачи)** – фиксация передачи машины между водителями.

### 3.2. Основные операции

- CRUD для всех сущностей (с учётом прав ролей).
- Фильтрация и поиск:
  - По машинам: регион, тип, бренд, номер, статус.
  - По ТО/ремонтам/запчастям: машина, период, тип работ.
  - По топливу: машина, период (месяц/год).
- Отображение связанных данных в карточке машины:
  - История ТО, ремонтов, запчастей.
  - История шин и аккумуляторов.
  - Страховки и техосмотры.
  - Пробег по месяцам и расход топлива.

### 3.3. Отчёты и экспорт

MVP‑отчёты:

- Отчёт по пробегу и расходу топлива по машине и компании (месячные/годовые срезы).
- Отчёт по затратам на запчасти и ремонты.
- Отчёт по страховкам и техосмотрам (актуальные/просроченные).

Требования:

- Возможность экспорта отчётов в **Excel (XLSX)** и **CSV**.
- В будущем – добавление PDF (подготовить слой генерации отчётов так, чтобы легко добавить PDF).

### 3.4. Локализация и форматы

- Интерфейс и статические тексты – через систему i18n (RU/EN/KY).
- Форматы:
  - Даты – в UI локализованные (например, `ДД.ММ.ГГГГ` для RU/KY, `YYYY-MM-DD` для EN).
  - Валюта – по умолчанию KGS (сом), формат `1 234,56`.

### 3.5. Безопасность и авторизация

- Авторизация по логину и паролю, с использованием JWT‑токенов (access + refresh).
- Обязательная фильтрация всех запросов по компании пользователя (запрет доступа к данным других компаний).
- Отсутствие 2FA в MVP, но оставить возможность его внедрения в будущем.

---

## 4. Backend (Django + DRF)

### 4.1. Технологический стек

- **Язык:** Python 3.11+
- **Фреймворк:** Django 4.2+.
- **API:** Django REST Framework 3.16+.
- **БД (продакшн):** PostgreSQL 15+.
- **Кэш/очереди (на будущее):** Redis, Celery (уведомления, тяжёлые отчёты).
- **Аутентификация:** JWT (например, `djangorestframework-simplejwt`).

### 4.2. Архитектура и multi-tenant

- Ввести модель `Company` и связать с ней:
  - `User` (OneToMany: одна компания – много пользователей).
  - Все бизнес‑сущности (`Car`, `Fuel`, `Spare`, `Insurance` и т.п.) через FK `company`.
- Реализовать middleware/permission‑слой:
  - Все запросы работают в контексте компании пользователя.
  - Пользователь не может читать/изменять данные другой компании.
- Структура проекта:
  - Разделение на приложения: `accounts`, `companies`, `fleet` (машины/ТО/топливо/страховки), `reports`, `core` (общие компоненты).

### 4.3. Модель данных (детализация)

Задача backend‑разработчика:

- На основе примера модели в `filesforai.txt` и списка сущностей в п.3.1 спроектировать ER‑диаграмму.
- Нормализовать данные (убрать дублирование, использовать справочники там, где уместно).
- Учесть многоязычность (например, хранение внутренних кодов + отображение через i18n на фронте).

Для каждой модели:

- Определить обязательные/необязательные поля и валидацию.
- Настроить `verbose_name` / `verbose_name_plural` (RU) для админки.
- Задать индексы по часто используемым фильтрам (компания, машина, дата, тип записи).

### 4.4. API (REST)

Базовый префикс: `/api/v1/`.

Минимальный набор эндпоинтов (пример):

- **Auth**
  - `POST /api/v1/auth/login/` – логин, выдача access/refresh.
  - `POST /api/v1/auth/refresh/` – обновление токена.
  - `POST /api/v1/auth/logout/` – инвалидация refresh (по возможности).

- **Companies & Users**
  - `GET/POST /api/v1/companies/` – только для системных админов (на будущее).
  - `GET/POST /api/v1/users/` – создание/просмотр пользователей компании (только админ компании).
  - `PATCH/DELETE /api/v1/users/{id}/`.

- **Fleet**
  - `GET/POST /api/v1/cars/`, `GET/PATCH/DELETE /api/v1/cars/{id}/`.
  - Вложенные/связанные ресурсы: `/cars/{id}/photos/`, `/cars/{id}/spares/`, `/cars/{id}/fuel/`, `/cars/{id}/insurances/`, `/cars/{id}/inspections/`, `/cars/{id}/mileage/`.

- **Reports**
  - `GET /api/v1/reports/fuel-consumption/` (фильтры: компания, машина, период).
  - `GET /api/v1/reports/maintenance-costs/`.
  - `GET /api/v1/reports/insurance-inspection/`.
  - Параметр `export={csv|xlsx}` для экспорта.

Требования к API:

- Пагинация по умолчанию (например, `page_size=20`, с возможностью изменения через query‑параметр в пределах лимита).
- Единый формат ошибок (код + сообщение + детали по полям).
- Использовать сериализаторы DRF, валидаторы и `ModelViewSet` там, где уместно.

### 4.5. Отчёты (backend)

- Реализовать слой генерации отчётов отделённо от HTTP‑контроллеров (сервисы/классы).
- Поддержать разные форматы вывода: JSON (для UI), CSV/XLSX (для экспорта).
- Закладывать возможность вынести тяжёлые отчёты в фоновые задачи (Celery).

### 4.6. Нефункциональные требования (backend)

- Время ответа для стандартных запросов (без тяжёлых отчётов) – до **500 мс** при средних нагрузках.
- Логирование:
  - Все ошибки уровня `ERROR` и выше – в лог.
  - Аудит‑лог важных действий (создание/удаление машины, изменение страховки и т.п.).
- Разделение конфигураций: `settings/base.py`, `settings/dev.py`, `settings/prod.py`.
- Использование `.env` для секретов (SECRET_KEY, параметры БД и т.п.).

### 4.7. Деплой

- Подготовить Docker‑образ для backend (Django + Gunicorn/Uvicorn).
- docker-compose для локальной разработки (web + db + redis (на будущее)).
- Продакшн: отдельный web‑сервер (Nginx) + приложение в Docker‑контейнерах.

---

## 5. UX/UI

### 5.1. Общие принципы

- Интерфейс рассчитан на:
  - **desktop** (полный функционал);
  - **mobile web** (упрощённые сценарии, ключевые функции – просмотр и ввод данных, без тяжёлых отчётов).
- Современный «чистый» UI, без лишних декоративных элементов.
- Единый дизайн‑язык для всех ролей, различия – только в доступных разделах и действиях.

### 5.2. Навигация и структура

Базовое верхнеуровневое меню (для desktop):

- **Dashboard** – сводка по автопарку (кол-во машин, активные страховки/ТО, ближайшие события).
- **Машины (Fleet)** – список машин, фильтры, карточка машины.
- **ТО и ремонты** – список работ/запчастей.
- **Топливо и пробег** – формы для ввода и отчёты.
- **Отчёты (Reports)** – доступ к готовым отчётам.
- **Настройки (Settings)** – пользователи, роли, параметры компании.

Для mobile:

- Нижнее таб‑меню (4–5 ключевых разделов) + бургер‑меню для остального.
- Упрощённые списки, минимальное количество столбцов в таблицах.

### 5.3. Основные экраны

Для каждого раздела предусмотреть:

- Список с фильтрами, пагинацией и поиском.
- Карточку детали (машины, ТО, топлива и т.п.) с вкладками:
  - Общая информация.
  - История (ремонты, топливо, пробег).
  - Файлы/фото.

### 5.4. Формы и валидация

- Все формы должны иметь:
  - Чёткие подписи полей.
  - Подсказки (placeholder, help text) там, где нужна подсказка формата (например, для дат и номера).
  - Валидацию на фронте и бэкенде, понятные сообщения об ошибках.

### 5.5. Локализация (UX)

- Все тексты (заголовки, подписи, ошибки) брать из словаря i18n.
- Механика переключения языка в интерфейсе (в хедере или настройках профиля).

---

## 6. Frontend (React)

### 6.1. Технологический стек

- **React 18+**, предпочтительно **TypeScript**.
- **React Router v6** для маршрутизации.
- **State Management:** Redux Toolkit + RTK Query (или аналог) для работы с API.
- **UI‑библиотека:** Material UI (MUI) или Ant Design (выбрать одну и использовать последовательно).
- **i18n:** `react-i18next` или аналогичная библиотека.
- **Диаграммы:** лёгкая библиотека графиков (например, Recharts) для отчётов.

Отдельная задача: **оценить целесообразность использования Next.js**:

- Подготовить краткое сравнение SPA (React + React Router) vs Next.js для данного проекта.
- По результату выбрать подход:
  - Если SSR и SEO не критичны – оставить SPA.
  - Если потребуется SEO/SSR – рассмотреть миграцию на Next.js.

### 6.2. Архитектура фронтенда

Рекомендуемая структура:

- `src/`
  - `app/` – точка входа, корневые провайдеры.
  - `modules/` – функциональные модули (auth, fleet, reports, settings и т.п.).
  - `shared/` – общие компоненты (таблицы, формы, модалки, кнопки).
  - `services/` – клиенты API (если не используется RTK Query – тогда здесь обёртки над fetch/axios).
  - `store/` – конфигурация Redux.
  - `i18n/` – конфигурация и словари локализации.

### 6.3. Страницы и роуты

Базовые роуты (пример):

- `/login` – авторизация.
- `/` – дашборд.
- `/cars` – список машин.
- `/cars/:id` – карточка машины.
- `/maintenance` – ТО и ремонты.
- `/fuel` – учёт топлива.
- `/reports` – отчёты.
- `/settings/users` – пользователи и роли.
- `/settings/company` – настройки компании.

### 6.4. Работа с API

- Вынести базовый HTTP‑клиент (axios/fetch) с:
  - автоматической подстановкой JWT access‑токена;
  - обработкой 401 (redirect на логин, обновление токена);
  - обработкой ошибок и отображением уведомлений.
- Для всех запросов использовать типы (TypeScript) и единые интерфейсы моделей.

### 6.5. Локализация (frontend)

- Структура файлов переводов: отдельные JSON/TS файлы для RU/EN/KY.
- Ключи вида `module.page.element` (например, `fleet.cars.list.title`).
- Переключение языка без перезагрузки страницы.

### 6.6. Тестирование (frontend)

- Написать базовые unit‑тесты для критичных компонентов (формы логина, таблицы машин и т.п.) с использованием Jest + Testing Library.

---

## 7. Дополнительно

- Вести документацию по API (OpenAPI/Swagger) и поддерживать её в актуальном состоянии.
- Подготовить базовый seed‑скрипт (демо‑данные) для разработки и тестирования (1–2 компании, несколько машин, записи по ТО/топливу).
- Заложить возможность дальнейшего расширения: интеграция с GPS, 1С, топливными картами, push‑уведомления и т.п.

## 8. AI‑ассистент (после MVP)

После реализации основных функций системы и перед этапом продакшн‑деплоя планируется добавить модуль AI‑ассистента.

### 8.1. Назначение

- Предоставить пользователю текстовый интерфейс (чат) для работы с данными автопарка на естественном языке.
- Упростить формирование отчётов, графиков и выборок без ручной настройки фильтров.
- Позволить по запросу пользователя создавать, изменять и удалять записи (в рамках прав доступа).

AI‑ассистент работает **строго в контексте одной компании** и не имеет доступа к данным других компаний.

### 8.2. Основные сценарии использования

- Генерация аналитических отчётов и обзоров:
  - Примеры запросов: «Покажи расход топлива по всем грузовым машинам за последние 6 месяцев»,
    «Сделай сравнительный отчёт по затратам на ТО по брендам за год».
- Формирование предложений по визуализации (графики, диаграммы) для фронтенда:
  - AI возвращает агрегированные данные и рекомендации по типу графика (линейный, столбчатый, круговая диаграмма и т.п.).
- Управление данными по запросу пользователя:
  - Создание новых записей (машины, ТО, заправки, страховки и т.д.).
  - Обновление и удаление существующих записей.
  - Все операции проходят через стандартные backend‑endpoint’ы и проверку прав.

### 8.3. Безопасность и ограничения

- AI‑ассистент **не должен** обходить ролевую модель и ограничения по компании.
  - Любое действие AI исполняется через backend‑слой с проверкой прав так же, как если бы его выполнял пользователь вручную.
- Ведение подробного аудита AI‑действий:
  - Логирование запросов пользователя к AI (без лишних персональных данных).
  - Логирование решений AI (какие endpoint’ы вызваны, какие изменения в БД выполнены).
- Запрет на использование данных одной компании для обучения моделей, используемых другой компанией (изоляция данных на уровне обучения и инференса).

### 8.4. Технические требования (общие)

- Интеграция AI как отдельного сервиса/слоя, взаимодействующего с backend через чётко определённые интерфейсы.
- Использование существующих API endpoint’ов для всех действий над данными (без прямой записи в БД в обход бизнес‑логики).
- Поддержка «dry‑run» режима, когда AI предлагает список предполагаемых изменений, но они применяются только после явного подтверждения пользователем (на фронтенде).
